<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArgMind</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--primary-color);
            line-height: 1.6;
        }

        .navbar {
            background-color: var(--primary-color);
            padding: 1rem;
        }

        .navbar-brand {
            color: white !important;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .feedback-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .skill-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }

        .skill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress {
            height: 10px;
            margin: 1rem 0;
        }

        .feedback-textarea {
            min-height: 200px;
            resize: vertical;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .skill-progress {
            position: relative;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .skill-progress-bar {
            height: 100%;
            background-color: var(--secondary-color);
            transition: width 0.5s ease-in-out;
        }

        .recommendation-card {
            background: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            padding: 1rem;
            margin: 1rem 0;
        }

        .priority-high { border-left-color: var(--accent-color); }
        .priority-medium { border-left-color: #f39c12; }
        .priority-low { border-left-color: #27ae60; }

        .skill-matrix {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 20px 0;
        }

        .mastery-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            color: white;
            font-size: 0.9em;
        }

        .mastery-high { background-color: #27ae60; }
        .mastery-medium { background-color: #f39c12; }
        .mastery-low { background-color: #e74c3c; }

        .skill-breakdown {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .practice-button {
            display: block;
            width: 100%;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .practice-button:hover {
            background-color: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .practice-section {
            display: none;  /* Hide by default */
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .practice-progress {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .exercise-counter {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .exercise-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }

        .exercise-input {
            width: 100%;
            min-height: 100px;
            margin: 1rem 0;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .feedback-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-right: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-success { background-color: #d4edda; color: #155724; }
        .badge-warning { background-color: #fff3cd; color: #856404; }
        .badge-danger { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">ArgMind</a>
        </div>
    </nav>

    <div class="main-container">
        <div class="row">
            <div class="col-md-8">
                <div class="feedback-section">
                    <h2>Submit Your Essay</h2>
                    <div class="mb-4">
                        <label for="essayInput" class="form-label">Enter your argumentative essay:</label>
                        <textarea id="essayInput" class="form-control feedback-textarea" placeholder="Paste your essay here..."></textarea>
                    </div>
                    <button onclick="analyzeEssay()" id="analyzeBtn" class="btn btn-primary">Analyze Essay</button>
                </div>

                <div id="loadingSpinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing your essay...</p>
                </div>

                <div id="feedbackResults" class="feedback-section" style="display: none;">
                    <h2>Analysis Results</h2>
                    <div id="skillsAnalysis"></div>
                    <div id="personalizedFeedback" class="mt-4"></div>
                    <div id="recommendedSteps" class="mt-4"></div>
                    
                    <!-- Add Practice Button -->
                    <button id="startPracticeBtn" class="practice-button" onclick="togglePracticeSection()">
                        Start Personalized Practice Exercises
                    </button>

                    <!-- Practice Section -->
                    <div id="practiceSection" class="practice-section">
                        <h3>Personalized Practice Exercises</h3>
                        <div class="practice-progress">
                            <div class="exercise-counter">
                                Progress: <span id="completedExercises">0</span> / <span id="totalExercises">0</span> exercises completed
                            </div>
                            <div class="progress">
                                <div id="exerciseProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <p class="text-muted">Based on your analysis, here are some targeted exercises to improve your writing skills:</p>
                        <div id="exerciseContainer"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="feedback-section">
                    <h3>Your Progress</h3>
                    <div id="progressTracking"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add this at the start of your script section
        const HUGGING_FACE_API_KEY = process.env.NEXT_PUBLIC_HUGGING_FACE_API_KEY || process.env.HUGGING_FACE_API_KEY;
        
        function analyzeEssay() {
            const essayText = document.getElementById('essayInput').value.trim();
            if (!essayText) {
                alert('Please enter your essay first.');
                return;
            }

            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('feedbackResults').style.display = 'none';

            // Remove artificial delay and process immediately
            currentAnalysis = performNeuralCDMAnalysis(essayText);
            displayResults(currentAnalysis);
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function performNeuralCDMAnalysis(essay) {
            // Cache toLowerCase() result to avoid multiple conversions
            const lowerEssay = essay.toLowerCase();
            
            // Optimize text analysis with single pass
            const words = essay.split(/\s+/);
            const wordCount = words.length;
            const sentences = essay.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const paragraphs = essay.split('\n\n').filter(p => p.trim().length > 0);
            
            // Optimize word pattern matching
            const patterns = {
                thesis: ['thesis', 'argue', 'believe', 'position', 'contend', 'maintain', 'claim', 'assert'],
                evidence: ['because', 'therefore', 'consequently', 'research', 'study', 'according', 'shows', 'demonstrates', 'proves'],
                transitions: ['however', 'moreover', 'furthermore', 'additionally', 'nevertheless', 'consequently', 'therefore', 'thus'],
                conclusion: ['conclusion', 'in summary', 'thus', 'finally', 'to conclude', 'in conclusion', 'ultimately', 'overall'],
                sophisticated: ['moreover', 'furthermore', 'consequently', 'nevertheless', 'specifically', 'significantly', 'fundamental', 'essentially']
            };

            // Single pass pattern matching
            const matches = {};
            Object.keys(patterns).forEach(type => {
                matches[type] = patterns[type].reduce((count, word) => 
                    count + (lowerEssay.match(new RegExp(word, 'g')) || []).length, 0);
            });

            // Calculate all scores at once
            const scores = {
                thesis: calculateThesisScore(matches.thesis, paragraphs[0] || ''),
                evidence: Math.min(100, matches.evidence * 20),
                flow: Math.min(100, (matches.transitions * 15 + (paragraphs.length >= 3 ? 40 : 0))),
                conclusion: calculateConclusionScore(matches.conclusion, paragraphs[paragraphs.length - 1] || ''),
                language: calculateLanguageScore(matches.sophisticated, words)
            };

            return {
                skillAnalysis: {
                    thesis_mastery: {
                        overallScore: scores.thesis,
                        aspects: {
                            development: {
                                feedback: getMasteryFeedback('thesis', scores.thesis)
                            }
                        }
                    },
                    evidence_mastery: {
                        overallScore: scores.evidence,
                        aspects: {
                            usage: {
                                feedback: getMasteryFeedback('evidence', scores.evidence)
                            }
                        }
                    },
                    logical_flow: {
                        overallScore: scores.flow,
                        aspects: {
                            coherence: {
                                feedback: getMasteryFeedback('flow', scores.flow)
                            }
                        }
                    },
                    conclusion_mastery: {
                        overallScore: scores.conclusion,
                        aspects: {
                            strength: {
                                feedback: getMasteryFeedback('conclusion', scores.conclusion)
                            }
                        }
                    },
                    language_mastery: {
                        overallScore: scores.language,
                        aspects: {
                            sophistication: {
                                feedback: getMasteryFeedback('language', scores.language)
                            }
                        }
                    }
                },
                personalizedFeedback: generateNeuralCDMFeedback(scores),
                recommendedSteps: generateAdaptiveLearningPath(scores)
            };
        }

        function calculateThesisScore(thesisMatches, firstParagraph) {
            const hasThesisIndicators = thesisMatches > 0;
            const hasEarlyThesis = firstParagraph && 
                hasThesisIndicators && 
                firstParagraph.split('.').length >= 2;
            return hasThesisIndicators ? (hasEarlyThesis ? 85 : 65) : 30;
        }

        function calculateConclusionScore(conclusionMatches, lastParagraph) {
            const hasConclusion = conclusionMatches > 0;
            const hasSummary = lastParagraph && lastParagraph.length > 100;
            return hasConclusion ? (hasSummary ? 90 : 70) : 30;
        }

        function calculateLanguageScore(sophisticatedMatches, words) {
            const avgWordLength = words.reduce((sum, word) => sum + word.length, 0) / words.length;
            return Math.min(100, sophisticatedMatches * 10 + (avgWordLength > 5 ? 40 : 20));
        }

        function getMasteryFeedback(skill, score) {
            if (score >= 80) {
                return `Excellent mastery of ${skill} skills! Keep maintaining this level.`;
            } else if (score >= 60) {
                return `Good progress in ${skill}. Focus on fine-tuning your skills.`;
            } else {
                return `Your ${skill} skills need attention. Focus on the recommended improvements.`;
            }
        }

        function generateNeuralCDMFeedback(scores) {
            const feedbacks = [];
            const avgScore = (scores.thesis + scores.evidence + scores.flow + scores.conclusion + scores.language) / 5;

            if (avgScore < 60) {
                feedbacks.push("Your writing shows potential but needs structured improvement.");
            } else if (avgScore < 80) {
                feedbacks.push("You're developing good argumentative writing skills.");
            } else {
                feedbacks.push("You demonstrate strong argumentative writing abilities.");
            }

            Object.entries(scores).forEach(([skill, score]) => {
                if (score < 60) {
                    feedbacks.push(`Focus on improving your ${skill.replace(/_/g, ' ')}.`);
                }
            });

            return feedbacks.join(' ');
        }

        function generateAdaptiveLearningPath(scores) {
            const steps = [];
            Object.entries(scores)
                .sort((a, b) => a[1] - b[1])
                .forEach(([skill, score]) => {
                    if (score < 80) {
                        steps.push({
                            skill: skill.replace(/_/g, ' '),
                            description: getSkillImprovement(skill, score),
                            priority: score < 60 ? "high" : "medium"
                        });
                    }
                });
            return steps;
        }

        function getSkillImprovement(skill, score) {
            const improvements = {
                thesis_mastery: "Practice writing clear and focused thesis statements that outline your main argument.",
                evidence_mastery: "Incorporate more specific evidence and examples to support your claims.",
                logical_flow: "Use transition words and phrases to better connect your ideas.",
                conclusion_mastery: "Strengthen your conclusions by summarizing key points and reinforcing your argument.",
                language_mastery: "Expand your vocabulary and vary your sentence structures."
            };
            return improvements[skill] || "Focus on improving this skill through practice.";
        }

        function generateExercises(scores) {
            const exercises = [];
            const weaknesses = Object.entries(scores)
                .filter(([_, score]) => score < 80)
                .sort((a, b) => a[1] - b[1]);

            weaknesses.forEach(([skill, score]) => {
                const exercise = generateExerciseForSkill(skill, score);
                if (exercise) {
                    exercises.push(exercise);
                }
            });

            return exercises;
        }

        async function generateExerciseForSkill(skill, score) {
            try {
                const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${HUGGING_FACE_API_KEY}`
                    },
                    body: JSON.stringify({
                        inputs: `Generate a writing exercise for improving ${skill} skills at ${score < 60 ? 'beginner' : score < 80 ? 'intermediate' : 'advanced'} level.
                                Include:
                                1. A title for the exercise
                                2. Clear instructions
                                3. A writing prompt
                                4. 3-4 specific tips for improvement
                                5. Criteria for evaluation
                                Format as JSON with fields: title, instructions, prompt, tips, evaluationCriteria`,
                        parameters: {
                            max_length: 500,
                            temperature: 0.7,
                            top_p: 0.9
                        }
                    })
                });

                const result = await response.json();
                const exercise = JSON.parse(result[0].generated_text);

                return {
                    title: exercise.title,
                    instructions: exercise.instructions,
                    prompt: exercise.prompt,
                    tips: exercise.tips,
                    evaluationCriteria: exercise.evaluationCriteria,
                    skill: skill,
                    difficulty: score < 60 ? 'Fundamental' : score < 80 ? 'Intermediate' : 'Advanced'
                };
            } catch (error) {
                console.error('Error generating exercise:', error);
                return fallbackExercise(skill, score);
            }
        }

        async function checkExercise(button, skill) {
            const exerciseCard = button.closest('.exercise-card');
            const response = exerciseCard.querySelector('.exercise-input').value.trim();
            const prompt = exerciseCard.querySelector('.prompt').textContent;
            const feedbackContainer = exerciseCard.querySelector('.feedback-container');

            if (!response) {
                alert('Please write a response before checking.');
                return;
            }

            try {
                const result = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${HUGGING_FACE_API_KEY}`
                    },
                    body: JSON.stringify({
                        inputs: `As a writing instructor, evaluate this response for a ${skill} exercise.
                                
                                Exercise Prompt: ${prompt}
                                Student Response: ${response}
                                
                                Provide:
                                1. A score (0-100)
                                2. Specific strengths
                                3. Areas for improvement
                                4. Actionable suggestions
                                
                                Format as JSON with fields: score, strengths, improvements, suggestions`,
                        parameters: {
                            max_length: 500,
                            temperature: 0.3,
                            top_p: 0.9
                        }
                    })
                });

                const feedback = JSON.parse((await result.json())[0].generated_text);
                
                // Update progress only if not previously checked
                if (feedbackContainer.style.display === 'none') {
                    completedExercisesCount++;
                    updateExerciseProgress();
                }

                feedbackContainer.innerHTML = `
                    <div class="alert ${feedback.score >= 80 ? 'alert-success' : 'alert-info'}">
                        <h5>Score: ${feedback.score}%</h5>
                        <div class="strengths mb-2">
                            <strong>Strengths:</strong>
                            <ul>
                                ${feedback.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="improvements mb-2">
                            <strong>Areas for Improvement:</strong>
                            <ul>
                                ${feedback.improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="suggestions">
                            <strong>Suggestions:</strong>
                            <ul>
                                ${feedback.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                feedbackContainer.style.display = 'block';

                // Disable the check button after first use
                button.disabled = true;
                button.textContent = 'Response Checked';
            } catch (error) {
                console.error('Error checking exercise:', error);
                // Fallback to basic feedback if AI check fails
                const basicFeedback = analyzeExerciseResponse(response, skill);
                displayBasicFeedback(feedbackContainer, basicFeedback);
            }
        }

        function fallbackExercise(skill, score) {
            const exercises = {
                thesis: {
                    title: "Thesis Statement Practice",
                    instructions: "Write a clear thesis statement for the following topic:",
                    prompts: [
                        "Should social media usage be regulated for teenagers?",
                        "Is remote learning as effective as traditional classroom education?",
                        "Should environmental education be mandatory in schools?"
                    ],
                    tips: [
                        "State your main argument clearly",
                        "Take a specific position",
                        "Make it debatable"
                    ]
                },
                evidence: {
                    title: "Evidence Integration Exercise",
                    instructions: "Support the following claim with specific evidence:",
                    prompts: [
                        "Regular exercise improves academic performance.",
                        "Technology has changed modern communication.",
                        "Climate change affects local ecosystems."
                    ],
                    tips: [
                        "Use specific examples",
                        "Cite research or statistics",
                        "Connect evidence to your claim"
                    ]
                },
                flow: {
                    title: "Logical Flow Practice",
                    instructions: "Connect the following ideas using appropriate transition words:",
                    prompts: [
                        "Write three connected sentences about the benefits of reading.",
                        "Link these ideas: education, job opportunities, and economic growth.",
                        "Connect these concepts: technology, productivity, work-life balance."
                    ],
                    tips: [
                        "Use transition words",
                        "Ensure logical progression",
                        "Connect ideas smoothly"
                    ]
                },
                conclusion: {
                    title: "Conclusion Writing Practice",
                    instructions: "Write a strong conclusion paragraph for this main idea:",
                    prompts: [
                        "Technology's impact on modern education",
                        "The importance of environmental conservation",
                        "The role of exercise in mental health"
                    ],
                    tips: [
                        "Summarize key points",
                        "Reinforce main argument",
                        "End with impact"
                    ]
                },
                language: {
                    title: "Language Enhancement Exercise",
                    instructions: "Rewrite the following sentence using more sophisticated language:",
                    prompts: [
                        "The project was good and helped many people.",
                        "The student said the book was bad.",
                        "They made changes to fix the problem."
                    ],
                    tips: [
                        "Use precise vocabulary",
                        "Vary sentence structure",
                        "Include academic phrases"
                    ]
                }
            };

            const skillMap = {
                thesis_mastery: 'thesis',
                evidence_mastery: 'evidence',
                logical_flow: 'flow',
                conclusion_mastery: 'conclusion',
                language_mastery: 'language'
            };

            const mappedSkill = skillMap[skill];
            if (!exercises[mappedSkill]) return null;

            const exercise = exercises[mappedSkill];
            const randomPrompt = exercise.prompts[Math.floor(Math.random() * exercise.prompts.length)];

            return {
                title: exercise.title,
                instructions: exercise.instructions,
                prompt: randomPrompt,
                tips: exercise.tips,
                skill: mappedSkill,
                difficulty: score < 60 ? 'Fundamental' : 'Intermediate'
            };
        }

        function displayBasicFeedback(container, feedback) {
            container.innerHTML = `
                <div class="alert ${feedback.score >= 80 ? 'alert-success' : 'alert-info'}">
                    <h5>Feedback:</h5>
                    <p>${feedback.message}</p>
                    <div class="suggestions">
                        <strong>Suggestions for improvement:</strong>
                        <ul>
                            ${feedback.suggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            container.style.display = 'block';
        }

        function displayResults(results) {
            const feedbackResults = document.getElementById('feedbackResults');
            const skillsAnalysis = document.getElementById('skillsAnalysis');
            const personalizedFeedback = document.getElementById('personalizedFeedback');
            const recommendedSteps = document.getElementById('recommendedSteps');

            // Clear previous results
            skillsAnalysis.innerHTML = '';
            personalizedFeedback.innerHTML = '';
            recommendedSteps.innerHTML = '';

            // Add chart container
            skillsAnalysis.innerHTML = `
                <div class="skill-matrix">
                    <h3>Skill Mastery Analysis</h3>
                    <div class="chart-container">
                        <canvas id="skillsRadarChart"></canvas>
                    </div>
                </div>
            `;

            // Create radar chart
            const ctx = document.getElementById('skillsRadarChart').getContext('2d');
            const skillScores = Object.entries(results.skillAnalysis).map(([skill, data]) => ({
                skill: skill.replace(/_/g, ' '),
                score: data.overallScore
            }));

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: skillScores.map(s => s.skill),
                    datasets: [{
                        label: 'Skill Mastery',
                        data: skillScores.map(s => s.score),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });

            // Display detailed analysis
            Object.entries(results.skillAnalysis).forEach(([skill, analysis]) => {
                const skillCard = document.createElement('div');
                skillCard.className = 'skill-card';
                skillCard.innerHTML = `
                    <h4>${skill.replace(/_/g, ' ')}</h4>
                    <div class="skill-progress">
                        <div class="skill-progress-bar" style="width: ${analysis.overallScore}%"></div>
                    </div>
                    <p>Mastery Level: ${analysis.overallScore}%</p>
                    <div class="mastery-level ${analysis.overallScore >= 80 ? 'mastery-high' : 
                                             analysis.overallScore >= 60 ? 'mastery-medium' : 
                                             'mastery-low'}">
                        ${analysis.overallScore >= 80 ? 'High Mastery' : 
                          analysis.overallScore >= 60 ? 'Developing' : 
                          'Needs Improvement'}
                    </div>
                    <div class="aspects-breakdown">
                        ${Object.entries(analysis.aspects).map(([aspect, data]) => `
                            <div class="aspect-item">
                                <strong>${aspect}:</strong> ${data.feedback}
                            </div>
                        `).join('')}
                    </div>
                `;
                skillsAnalysis.appendChild(skillCard);
            });

            // Display personalized feedback
            personalizedFeedback.innerHTML = `
                <h3>Personalized Feedback</h3>
                <div class="alert alert-info">
                    ${results.personalizedFeedback}
                </div>
            `;

            // Display recommended steps
            recommendedSteps.innerHTML = `
                <h3>Recommended Next Steps</h3>
                ${results.recommendedSteps.map(step => `
                    <div class="recommendation-card priority-${step.priority}">
                        <h5>${step.skill}</h5>
                        <p>${step.description}</p>
                    </div>
                `).join('')}
            `;

            // Add exercise display
            const exerciseContainer = document.getElementById('exerciseContainer');
            exerciseContainer.innerHTML = '';

            const exercises = generateExercises(results.skillAnalysis);
            exercises.forEach(exercise => {
                const exerciseElement = document.createElement('div');
                exerciseElement.className = 'exercise-card';
                exerciseElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">${exercise.title}</h4>
                        <span class="feedback-badge ${exercise.difficulty === 'Fundamental' ? 'badge-danger' : 'badge-warning'}">
                            ${exercise.difficulty}
                        </span>
                    </div>
                    <p><strong>${exercise.instructions}</strong></p>
                    <p class="prompt">${exercise.prompt}</p>
                    <textarea class="exercise-input" placeholder="Write your response here..."></textarea>
                    <div class="tips">
                        <strong>Tips:</strong>
                        <ul>
                            ${exercise.tips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                    <button class="btn btn-primary mt-2" onclick="checkExercise(this, '${exercise.skill}')">
                        Check Response
                    </button>
                    <div class="feedback-container mt-2" style="display: none;"></div>
                `;
                exerciseContainer.appendChild(exerciseElement);
            });

            feedbackResults.style.display = 'block';
        }

        function togglePracticeSection() {
            const practiceSection = document.getElementById('practiceSection');
            const startButton = document.getElementById('startPracticeBtn');
            
            if (practiceSection.style.display === 'none') {
                practiceSection.style.display = 'block';
                startButton.textContent = 'Hide Practice Exercises';
                if (currentAnalysis) {
                    initializePracticeSession();
                } else {
                    alert('Please analyze an essay first to get personalized exercises.');
                    practiceSection.style.display = 'none';
                    startButton.textContent = 'Start Personalized Practice Exercises';
                }
            } else {
                practiceSection.style.display = 'none';
                startButton.textContent = 'Start Personalized Practice Exercises';
            }
        }

        async function initializePracticeSession() {
            const exerciseContainer = document.getElementById('exerciseContainer');
            const totalExercises = document.getElementById('totalExercises');
            
            try {
                // Generate exercises based on current analysis
                const exercises = await Promise.all(
                    Object.entries(currentAnalysis.skillAnalysis)
                        .filter(([_, data]) => data.overallScore < 80)
                        .sort(([_, a], [_, b]) => a.overallScore - b.overallScore)
                        .map(async ([skill, data]) => await generateExerciseForSkill(skill, data.overallScore))
                );

                const validExercises = exercises.filter(ex => ex !== null);
                
                totalExercises.textContent = validExercises.length;
                updateExerciseProgress();
                
                exerciseContainer.innerHTML = '';
                validExercises.forEach((exercise, index) => {
                    const exerciseElement = document.createElement('div');
                    exerciseElement.className = 'exercise-card';
                    exerciseElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">Exercise ${index + 1}: ${exercise.title}</h4>
                            <span class="feedback-badge ${exercise.difficulty === 'Fundamental' ? 'badge-danger' : 'badge-warning'}">
                                ${exercise.difficulty}
                            </span>
                        </div>
                        <p><strong>${exercise.instructions}</strong></p>
                        <p class="prompt">${exercise.prompt}</p>
                        <textarea class="exercise-input" placeholder="Write your response here..."></textarea>
                        <div class="tips">
                            <strong>Tips:</strong>
                            <ul>
                                ${exercise.tips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </div>
                        <button class="btn btn-primary mt-2" onclick="checkExercise(this, '${exercise.skill}')">
                            Check Response
                        </button>
                        <div class="feedback-container mt-2" style="display: none;"></div>
                    `;
                    exerciseContainer.appendChild(exerciseElement);
                });
            } catch (error) {
                console.error('Error initializing practice session:', error);
                exerciseContainer.innerHTML = '<div class="alert alert-danger">Error loading exercises. Please try again.</div>';
            }
        }

        let completedExercisesCount = 0;
        let currentAnalysis = null;

        function updateExerciseProgress() {
            const completedSpan = document.getElementById('completedExercises');
            const totalSpan = document.getElementById('totalExercises');
            const progressBar = document.getElementById('exerciseProgress');
            
            const total = parseInt(totalSpan.textContent);
            completedSpan.textContent = completedExercisesCount;
            
            const progressPercentage = (completedExercisesCount / total) * 100;
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.setAttribute('aria-valuenow', progressPercentage);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>